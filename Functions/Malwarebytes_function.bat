@echo off

REM Set variables
set Restore_State_Malwarebytes=unidentified
set Skip_Install_Mbam=no
set VarMbytes=0
set Install_Directory=unidentified
set Malwarebytes_Infections=unidentified

REM Enable delayed expansion
SETLOCAL ENABLEDELAYEDEXPANSION

REM Check for testing mode since this is an experimental tool still
if not "%PASSWORD%"=="RedRuby" (
  REM Set variable
  set Malwarebytes=No
  REM Display message that user is not in testing mode
  %Output%\Functions\Menu\MessageBox "You are not in testing mode and are not able to try Experimental tools.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 30 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:Y /I:E /O:N /T:10
  GOTO :EOF
)

REM Check for windows 7 or above
if not %WIN_VER_NUM% geq 6.1 (
  REM Display message that user is not in testing mode
  %Output%\Functions\Menu\MessageBox "Malwarebytes does not support '%WIN_VER%'.\n\nYou will have to install/run your tools manually.\n\nSorry.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:Y /I:E /O:N /T:10
  GOTO :EOF
)

REM Setup resume state if not found, if found ask if you want to resume
if exist "!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt" (
  REM Display message showing that previous state was found
  FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\MessageBox "Previous state found.\n\nDo you want to restore the previous session\u003F" "[ALERT] Brainiacs Cleanup Tool v%TOOL_VERSION%" /B:Y /I:A /O:N`) DO (
    IF /I "%%G"=="Yes" (
      goto :restore_yes
    ) ELSE (
      goto :restore_no
    )
  )
  REM Set flag for continuing with restore point
	:restore_yes
  REM Create restore point
  set /p Restore_State_Malwarebytes=<!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Go to restore point.
	goto !Restore_State_Malwarebytes!
)
REM Set flag for continuing without restore point
:restore_no

REM Check if Malwarebytes is installed.
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe" (
  REM Display message that existing installation was found
  %Output%\Functions\Menu\MessageBox "Existing MBAM installation detected.\n\nSkipping installation.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:Y /I:E /O:N /T:10
  REM Create restore point
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Start MBAM
	goto Run_MBAM
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe" (
  REM Display message that existing installation was found
  %Output%\Functions\Menu\MessageBox "Existing MBAM installation detected.\n\nSkipping installation.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:Y /I:E /O:N /T:10
  REM Create restore point
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Start MBAM
	goto Run_MBAM
)
if exist "!systemdrive!\Malwarebytes\mbam.exe" (
  REM Display message that existing installation was found
  %Output%\Functions\Menu\MessageBox "Existing MBAM installation detected.\n\nSkipping installation.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:Y /I:E /O:N /T:10
  REM Create restore point
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Start MBAM
	goto Run_MBAM
) else (
  REM Create restore point
	echo Install_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Start MBAM installation
	goto Install_MBAM
)

REM Install Malwarebytes.
:Install_MBAM
if exist "!Output!\Tools\Malwarebytes\mb3-setup.exe" (
  REM Display message that tool will install MBAM
  FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\OpenFolderBox "!systemdrive!" "Select the folder where you would like Malwarebytes to be installed." /MD`) DO (
    REM Set variable
    set Install_Directory=%%G
  )

  if "!Install_Directory!"=="unidentified" (
    REM Display message that no directory was entered
    FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\MessageBox "No directory was selected or you are trying to quit.\n\nDo you want to quit the Malwarebytes installation\u003F" "[ALERT] Brainiacs Cleanup Tool v%TOOL_VERSION%" /B:Y /I:A /O:N`) DO (
      IF /I "%%G"=="Yes" (
    	  GOTO :EOF
      ) else (
        goto Install_MBAM
      )
    )
  )
  REM Start MBAM installation under selected directory
	start /WAIT "Malwarebytes" "!Output!\Tools\Malwarebytes\mb3-setup.exe" mbam-setup /dir=!Install_Directory! /VERYSILENT /NORESTART /SUPPRESSMSGBOXES /NOCANCEL /NOICONS
  REM Create restore point
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Start MBAM
	goto Run_MBAM
) else (
  REM Display message that installation file was not found
  %Output%\Functions\Menu\MessageBox "Malwarebytes installation files not found.\n\nSkipping.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:Y /I:E /O:N /T:10
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM installation
	goto Skip_MBAM
)

REM Run Malwarebytes.
:Run_MBAM

REM Check for Install_Directory variable
if not "!Install_Directory!"=="unidentified" (
	start /WAIT "Malwarebytes" /MAX "!Install_Directory!"
  REM Set notes
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
  REM Ask for amount of infections found & set notes
  FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\INPUTBOX "Enter the amount of infections found:" "[INFECTIONS] Malwarebytes" /H:150 /W:280 /M:"####" /F:"\d{0,4}" /U /I`) DO (
    REM Set variable
    set Malwarebytes_Infections=%%G
  )
  REM Set comments based on variable
  IF NOT "!Malwarebytes_Infections!"=="unidentified" (
    echo Infections-"!Malwarebytes_Infections!" >> "%Output%\Notes\Comments.txt"
  ) else (
    echo No infections found. >> "%Output%\Notes\Comments.txt"
  )
  REM Create restore point
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Uninstall MBAM
	goto Uninstall_MBAM_Next
)

REM Check for !systemdrive!\Malwarebytes\mbam.exe
if exist "!systemdrive!\Malwarebytes\mbam.exe" (
	start /WAIT "Malwarebytes" /MAX "!systemdrive!\Malwarebytes\mbam.exe"
  REM Set notes
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
  REM Ask for amount of infections found & set notes
  FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\INPUTBOX "Enter the amount of infections found:" "[INFECTIONS] Malwarebytes" /H:150 /W:280 /M:"####" /F:"\d{0,4}" /U /I`) DO (
    REM Set variable
    set Malwarebytes_Infections=%%G
  )
  REM Set comments based on variable
  IF NOT "!Malwarebytes_Infections!"=="unidentified" (
    echo Infections-"!Malwarebytes_Infections!" >> "%Output%\Notes\Comments.txt"
  ) else (
    echo No infections found. >> "%Output%\Notes\Comments.txt"
  )
  REM Create restore point
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Uninstall MBAM
	goto Uninstall_MBAM_Next
)

REM Check for !ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe" (
	start /WAIT "Malwarebytes" /MAX "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe"
  REM Set notes
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
  REM Ask for amount of infections found & set notes
  FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\INPUTBOX "Enter the amount of infections found:" "[INFECTIONS] Malwarebytes" /H:150 /W:280 /M:"####" /F:"\d{0,4}" /U /I`) DO (
    REM Set variable
    set Malwarebytes_Infections=%%G
  )
  REM Set comments based on variable
  IF NOT "!Malwarebytes_Infections!"=="unidentified" (
    echo Infections-"!Malwarebytes_Infections!" >> "%Output%\Notes\Comments.txt"
  ) else (
    echo No infections found. >> "%Output%\Notes\Comments.txt"
  )
  REM Create restore point
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Uninstall MBAM
	goto Uninstall_MBAM_Next
)

REM Check for !ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe" (
	start /WAIT "Malwarebytes" /MAX "!ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe"
  REM Set notes
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
  REM Ask for amount of infections found & set notes
  FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\INPUTBOX "Enter the amount of infections found:" "[INFECTIONS] Malwarebytes" /H:150 /W:280 /M:"####" /F:"\d{0,4}" /U /I`) DO (
    REM Set variable
    set Malwarebytes_Infections=%%G
  )
  REM Set comments based on variable
  IF NOT "!Malwarebytes_Infections!"=="unidentified" (
    echo Infections-"!Malwarebytes_Infections!" >> "%Output%\Notes\Comments.txt"
  ) else (
    echo No infections found. >> "%Output%\Notes\Comments.txt"
  )
  REM Create restore point
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Uninstall MBAM
	goto Uninstall_MBAM_Next
) else (
  REM Display message that tool was not found.
  %Output%\Functions\Menu\MessageBox "Malwarebytes Anti-Malware not found.\n\nSkipping.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:O /I:E /O:N /T:10
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)

REM Uninstall Malwarebytes.
:Uninstall_MBAM_Next
REM Display message that no directory was entered
FOR /F "usebackq tokens=1" %%G IN (`%Output%\Functions\Menu\MessageBox "Do you want to uninstall Malwarebytes\u003F" "[ALERT] Brainiacs Cleanup Tool v%TOOL_VERSION%" /B:Y /I:A /O:N`) DO (
  IF /I "%%G"=="No" (
    goto Skip_MBAM
  )
)

REM Check for pre-installed Malwarebytes !Install_Directory!
if exist "!Install_Directory!\unins000.exe" (
	start /WAIT "Malwarebytes" "!Install_Directory!\unins000.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!Install_Directory!\unins001.exe" (
	start /WAIT "Malwarebytes" "!Install_Directory!\unins001.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!Install_Directory!\unins003.exe" (
	start /WAIT "Malwarebytes" "!Install_Directory!\unins003.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)

REM Check for pre-installed Malwarebytes !ProgramFiles(x86)!\Malwarebytes\Anti-Malware\
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins000.exe" (
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins000.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins001.exe" (
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins001.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins003.exe" (
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins003.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)

REM Check for pre-installed Malwarebytes !ProgramFiles!\Malwarebytes\Anti-Malware\
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins000.exe" (
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\unins000.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins001.exe" (
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\unins001.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins003.exe" (
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\unins003.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)

REM Check for pre-installed Malwarebytes !systemdrive!\Malwarebytes\
if exist "!systemdrive!\Malwarebytes\unins000.exe" (
	start /WAIT "!systemdrive!\Malwarebytes\unins000.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins001.exe" (
	start /WAIT "!systemdrive!\Malwarebytes\unins001.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
if exist "!systemdrive!\Malwarebytes\unins003.exe" (
	start /WAIT "Malwarebytes" "!systemdrive!\Malwarebytes\unins003.exe" /verysilent /suppressmsgboxes /norestart
  REM Set notes
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
  REM Create restore point
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
) else (
  REM Display message that tool was not found.
  %Output%\Functions\Menu\MessageBox "Malwarebytes Anti-Malware not found.\n\nSkipping.\n\nThe Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds." "[ERROR] Brainiacs Cleanup Tool" /B:O /I:E /O:N /T:10
  REM Create restore point
  echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
  REM Skip MBAM
	goto Skip_MBAM
)
:Skip_MBAM

REM Delete restore point if found.
if exist "!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt" (
  del /Q "!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt"
)

REM Disable delayed expansion
ENDLOCAL DISABLEDELAYEDEXPANSION

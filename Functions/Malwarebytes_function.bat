@echo off
CLS

::Enable delayed expansion
setlocal enableDelayedExpansion

::Start Malwarebytes service.

::Set title
title [Malwarebytes] Brainiacs Cleanup Tool v!TOOL_VERSION!

::Set variables
set Restore_State_Malwarebytes=unidentified
set Skip_Install_Mbam=no
set "VarMbytes=0"

::If unsupported os then set variable to skip install.
if !WIN_VER_NUM! LSS 6.1 set Skip_Install_Mbam=yes

::Show the skip message is Windows is not the correct version.
if !Skip_Install_Mbam!==yes (
	color 0c
	echo.
	echo  ^! ERROR
	echo ===================================================================================
	echo.
	echo    Running Malwarebytes does not support "!WIN_VER!".
	echo.
	echo    You will have to install/run your tools manually.
	echo.
	echo    Sorry.
	echo.
  echo    The Brainiacs Cleanup Tool v!TOOL_VERSION! will now continue.
	echo.
	echo ===================================================================================
  TIMEOUT 15
	goto :EOF
)

::Setup resume state if not found, if found ask if you want to resume
if exist "!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt" (
	choice /M "Previous state found, do you want to restore the previous session" /c YN
	IF errorlevel 2 goto :restore_no
	IF errorlevel 1 goto :restore_yes
	:restore_yes
  set /p Restore_State_Malwarebytes=<!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto !Restore_State_Malwarebytes!
)
:restore_no
CLS

::Check if Malwarebytes is installed.
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe" (
	CLS
  color 0c
  echo.
  echo  ^! ERROR
  echo ===================================================================================
  echo.
  echo    Existing MBAM installation detected.
  echo.
  echo    Skipping installation...
  echo.
  echo    The Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 5 seconds.
  echo.
  echo ===================================================================================
  TIMEOUT 5
  color 07
	CLS
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Run_MBAM
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe" (
	CLS
  color 0c
  echo.
  echo  ^! ERROR
  echo ===================================================================================
  echo.
  echo    Existing MBAM installation detected.
  echo.
  echo    Skipping installation...
  echo.
  echo    The Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 5 seconds.
  echo.
  echo ===================================================================================
  TIMEOUT 5
  color 07
	CLS
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Run_MBAM
)
if exist "!systemdrive!\Malwarebytes\mbam.exe" (
	CLS
  color 0c
  echo.
  echo  ^! ERROR
  echo ===================================================================================
  echo.
  echo    Existing MBAM installation detected.
  echo.
  echo    Skipping installation...
  echo.
  echo    The Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 5 seconds.
  echo.
  echo ===================================================================================
  TIMEOUT 5
  color 07
	CLS
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Run_MBAM
) else (
	echo Install_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Install_MBAM
)

::Install Malwarebytes.
:Install_MBAM
if exist "!Output!\Tools\Malwarebytes\mb3-setup.exe" (
	echo Installing Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!Output!\Tools\Malwarebytes\mb3-setup.exe" mbam-setup /dir=!systemdrive!\Malwarebytes /VERYSILENT /NORESTART /SUPPRESSMSGBOXES /NOCANCEL /NOICONS
	CLS
	echo Malwarebytes Anti-Malware installed successfuly.
	TIMEOUT 3 >nul 2>&1
	CLS
	echo Run_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Run_MBAM
) else (
	CLS
  color 0c
  echo.
  echo  ^! ERROR
  echo ===================================================================================
  echo.
  echo    Malwarebytes installation files not found.
  echo.
  echo    Skipping...
  echo.
  echo    The Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds.
  echo.
  echo ===================================================================================
  TIMEOUT 10
  color 07
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	CLS
	goto Skip_MBAM
)

::Run Malwarebytes.
:Run_MBAM
if exist "!systemdrive!\Malwarebytes\mbam.exe" (
	echo Opening Malwarebytes Anti-Malware...
	echo This may take a while.
	echo If Malwarebytes does not open, it will be minimized as a taskbar icon near the time.
	start /WAIT "Malwarebytes" "!systemdrive!\Malwarebytes\mbam.exe" /runupdate
	CLS
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
	set /p VarMbytes=Enter the amount of infections found:
	echo Infections-!!VarMbytes!! >> !Output!\Notes\Comments.txt
	TIMEOUT 3 >nul 2>&1
	CLS
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Uninstall_MBAM_Next
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe" (
	echo Opening Malwarebytes Anti-Malware...
	echo This may take a while.
	echo If Malwarebytes does not open, it will be minimized as a taskbar icon near the time.
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\mbam.exe" /runupdate
	CLS
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
	set /p VarMbytes=Enter the amount of infections found:
	echo Infections-!!VarMbytes!! >> !Output!\Notes\Comments.txt
	TIMEOUT 3 >nul 2>&1
	CLS
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Uninstall_MBAM_Next
)
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe" (
	echo Opening Malwarebytes Anti-Malware...
	echo This may take a while.
	echo If Malwarebytes does not open, it will be minimized as a taskbar icon near the time.
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\mbam.exe" /runupdate
	CLS
	echo -Ran Malwarebytes >> !Output!\Notes\Comments.txt
	set /p VarMbytes=Enter the amount of infections found:
	echo Infections-!!VarMbytes!! >> !Output!\Notes\Comments.txt
	TIMEOUT 3 >nul 2>&1
	CLS
	echo Uninstall_MBAM_Next >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Uninstall_MBAM_Next
) else (
	CLS
  color 0c
  echo.
  echo  ^! ERROR
  echo ===================================================================================
  echo.
  echo    Malwarebytes Anti-Malware not found.
  echo.
  echo    Skipping...
  echo.
  echo    The Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds.
  echo.
  echo ===================================================================================
  TIMEOUT 10
  color 07
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	CLS
	goto Skip_MBAM
)
CLS

::Uninstall Malwarebytes.
:Uninstall_MBAM_Next
choice /T 10 /D Y /M "Uninstall Malwarebytes" /c YN
IF errorlevel 2 goto :Skip_MBAM
IF errorlevel 1 goto :Uninstall_MBAM
:Uninstall_MBAM
CLS
::Check for pre-installed Malwarebytes
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins000.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins000.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins001.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins001.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)
if exist "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins002.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!ProgramFiles(x86)!\Malwarebytes\Anti-Malware\unins002.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)

::Check for pre-installed Malwarebytes
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins000.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\unins000.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins001.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\unins001.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)
if exist "!ProgramFiles!\Malwarebytes\Anti-Malware\unins002.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!ProgramFiles!\Malwarebytes\Anti-Malware\unins002.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)

::Check for tool-installed Malwarebytes if not skip
if exist "!systemdrive!\Malwarebytes\unins000.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!systemdrive!\Malwarebytes\unins000.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)
if exist "!systemdrive!\Malwarebytes\unins001.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!systemdrive!\Malwarebytes\unins001.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
)
if exist "!systemdrive!\Malwarebytes\unins002.exe" (
	echo Uninstalling Malwarebytes Anti-Malware...
	start /WAIT "Malwarebytes" "!systemdrive!\Malwarebytes\unins002.exe" /verysilent /suppressmsgboxes /norestart
	CLS
	echo Uninstalled Malwarebytes.
	TIMEOUT 3 >nul 2>&1
	echo -Uninstalled Malwarebytes >> !Output!\Notes\Comments.txt
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	goto Skip_MBAM
) else (
	CLS
  color 0c
  echo.
  echo  ^! ERROR
  echo ===================================================================================
  echo.
  echo    Malwarebytes Anti-Malware not found.
  echo.
  echo    Skipping...
  echo.
  echo    The Brainiacs Cleanup Tool v%TOOL_VERSION% will continue in 10 seconds.
  echo.
  echo ===================================================================================
  TIMEOUT 10
  color 07
	echo Skip_MBAM >!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt
	CLS
	goto Skip_MBAM
)
:Skip_MBAM

::Delete restore point if found.
if exist "!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt" (
  del /Q "!Output!\Tools\Malwarebytes\Restore_State_Malwarebytes.txt"
)
CLS
::Disable delayed expansion
ENDLOCAL
